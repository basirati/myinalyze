{% extends 'riaapp/admin_base.html' %}
{% block content %}
<div class="row" style="margin-top: 3% margin: 0 auto; white-space: nowrap;">
  <textarea id="new_req_text" style="width:65%" placeholder="Write a new requirement here ..."></textarea>
  <a id="new_req_btn" href="#!" class="btn btn-primary" style=" margin-left: 2%; vertical-align: middle; ">Add New Requirement</a>
  <a id="scrollgraph_btn" href="#graphviz" class="btn btn-outline-primary" style=" margin-left: 1%; vertical-align: middle; ">Graph Visualization</a>
</div>
<div class="row" style="margin: 1% auto;">
  <div class="table-responsive">
    <table id="reqs_table" class="table align-items-center table-hover">
      <thead class="thead-light">
        <tr>
          <th scope="col" style="cursor: auto;">
            Requirement Specification
            <span style="margin-left: 2%;">
              <a id="seeallreqs_btn" href="{% url 'riaapp:searchresults' %}" class="btn btn-sm btn-primary" >See All Requirements</a>
              <a id="seealldeps_btn" href="{% url 'riaapp:depslist' %}" class="btn btn-sm btn-primary">See All Dependencies</a>  
            </span>
          </th>
          <th scope="col">Depending On <br> (Number of Requirements)</th>
          <th scope="col">Influencing On <br> (Number of Requirements)</th>
        </tr>
      </thead>
      <tbody>
        {% for r in sortedReqs %}
        <tr>
          <th hidden="true">
            {{r.id}}
          </th>
          <th scope="row" style="word-wrap: break-word; word-break: break-all; white-space: normal;">
            {{r.text}}
          </th>
          <td>
            {{r.indeg}}
          </td>
          <td>
            {{r.outdeg}}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% include "riaapp/graph.html" %}
{% endblock content %}

{% block javascript %}
<script>
  $('#scrollgraph_btn').click(function(){
    scrollingElement = (document.scrollingElement || document.body);
    $(scrollingElement).animate({
      scrollTop: $('#graph_container').position().top
    }, 500);
  });


  $(document).click(function() {
    $('#reqs_table > tbody > tr > th').popover('hide');
  });

  $('#reqs_table > tbody > tr > th').click(function(e) {
    e.stopPropagation();
    req_id = e.currentTarget.parentElement.children[0].innerText;
    $('#reqs_table > tbody > tr > th').popover('hide');
    $(e.target).popover({
      html: true,
      content: function() {
        return $('#popcontent').html();
      },
    });
    $.ajax({
      url: '/riaapp/getreqdeps/',
      data: {
        'req_id': req_id,
      },
      dataType: 'json',
      success: function (data) {
        $("#influencing_pop_tbody").empty();
        for (i in data.influencing) {
          $("#influencing_pop_tbody").append("<tr><td>" + data.influencing[i] + "</td></tr>");
        }
        $("#depending_pop_tbody").empty();
        for (i in data.depending) {
          $("#depending_pop_tbody").append("<tr><td>" + data.depending[i] + "</td></tr>");
        }
        $(e.target).popover('show');
        last_target = e.target;
        $('.popover').css('left', e.clientX + 'px');
        $('.popover').css('top', e.clientY + 'px')
      }
    });
  });

  function addReqFunction(){

    new_req_text = $('#new_req_text').val();
    $.ajax({
      url: '/riaapp/addreq/',
      data: {
        'req': new_req_text
      },
      dataType: 'json',
      success: function (data) {
        if (data.successful) {
          $('#reqs_table > tbody').empty();
          var flag = false;
          for (i in data.sortedReqs)
          {
            r = JSON.parse(data.sortedReqs[i]);
            if (r.text == new_req_text) { flag = true; }
            $('#reqs_table > tbody').append('<tr><th>'+r.text+'</th><td>'+ r.indeg +'</td><td>'+ r.outdeg +'</td></tr>');
          }
          if (flag == false) {
            $('#reqs_table > tbody:last-child').append('<tr><th>'+ JSON.parse(data.new_req).id +'</th><th>' + JSON.parse(data.new_req).text+'</th><td>' + JSON.parse(data.new_req).indeg + '</td><td>'+ JSON.parse(data.new_req).outdeg +'</td></tr>');
          }
        }
        else {
          alert("An error occured!");
        }
      }
    });
  }

  $('#new_req_text').keypress(function (e) {
    if(e.which == 13) {
      addReqFunction()
      $('#new_req_text').val("");
      e.preventDefault();
    }
  });
  $('#new_req_btn').click(function (e) {
    addReqFunction();
  });


  $('#graphbtn').click(function() {
    $('#presentation_type').html("Graph Presentation");
    d3.select("svg").selectAll("*").remove();
    $.get('/riaapp/getallreqsanddeps/', {}, function(data){
      nodes = [];
      for (var i = 0; i < data.jreqs.length; i++) {
        nodes.push({name: JSON.parse(data.jreqs[i]).text, outdeg: JSON.parse(data.jreqs[i]).outdeg, id: i+1});
      }
      links = [];
      for (var i = 0; i < data.jdeps.length; i++) {
        s = data.jdeps[i].source;
        d = data.jdeps[i].destination;
        si = -1; di = -1;
        for (var j = 0; j < nodes.length; j++) {
          if (nodes[j].name == s)
            si = nodes[j].id
          if (nodes[j].name == d)
            di = nodes[j].id
          if (si > -1 && di > -1)
            break;
        }
        links.push({source: si, target: di, type: "depends on"});
      }
      all = {};
      all["nodes"] = nodes;
      all["links"] = links;
      drawDJGraph(all, d3.select("svg"));
    });
  });

  $('#totop_btn').click(function(){
    scrollingElement = (document.scrollingElement || document.body);
    $(scrollingElement).animate({
      scrollTop: 0
    }, 500);
  });
</script>


{% endblock javascript %}
